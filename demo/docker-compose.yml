services:
  # Instrumented OpenWebUI - builds from local fork with LLM observability
  openwebui:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: openwebui-instrumented
    ports:
      - "3000:8080"
    volumes:
      - openwebui-data:/app/backend/data
    environment:
      # Gemini API Configuration
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - DEFAULT_MODEL=gemini-3-flash-preview
      - WEBUI_NAME=AI Bot Personalities - LLM Observability Demo

      # OpenWebUI Configuration
      - WEBUI_URL=http://localhost:3000
      - ENABLE_OPENAI_API=false

      # OpenTelemetry Tracing Configuration
      - ENABLE_OTEL=true
      - ENABLE_OTEL_TRACES=true
      - ENABLE_OTEL_METRICS=false

      # OTLP Exporter Configuration
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
      - OTEL_LOGS_EXPORTER=none
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
      - OTEL_EXPORTER_OTLP_INSECURE=true

      # Service Identification
      - OTEL_SERVICE_NAME=openwebui
      - OTEL_RESOURCE_ATTRIBUTES=deployment.environment=demo,service.version=instrumented

      # Exclude noisy endpoints from auto-instrumentation
      - OTEL_PYTHON_FASTAPI_EXCLUDED_URLS=/health,/api/health,/api/version,/api/config,/api/models,/api/v1,/api/tasks,/api/files,/api/auths,/api/chat/completed,/static/.*,/assets/.*,.*\.js,.*\.css,.*\.png,.*\.ico,.*\.svg,/ws

      # Disable noisy instrumentations (keep aiohttp for LLM API calls)
      - OTEL_PYTHON_DISABLED_INSTRUMENTATIONS=sqlite3,sqlalchemy,httpx,websocket

      # Logging level (optional - useful for debugging)
      - LOG_LEVEL=INFO

    networks:
      - llm-observability
    restart: unless-stopped
    depends_on:
      - otel-collector

  # OpenTelemetry Collector - receives traces and forwards to Grafana Cloud
  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: otel-collector
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
    ports:
      - "4317:4317"  # OTLP gRPC receiver
      - "4318:4318"  # OTLP HTTP receiver
      - "8888:8888"  # Prometheus metrics exposed by the collector
      - "8889:8889"  # Prometheus exporter metrics
    environment:
      # Grafana Cloud OTLP endpoint and credentials
      - GRAFANA_OTLP_TOKEN=${GRAFANA_OTLP_TOKEN}
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}
    networks:
      - llm-observability
    restart: unless-stopped

networks:
  llm-observability:
    driver: bridge

volumes:
  openwebui-data:
    external: true
    name: scdemografananet_openwebui-data
